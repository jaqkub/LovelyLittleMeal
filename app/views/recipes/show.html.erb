<%# Subscribe to Turbo Stream updates for this recipe %>
<%= turbo_stream_from "recipe_#{@recipe.id}" %>

<%# Set meta tags for recipe page (SEO and social sharing) %>
<% recipe_title = @recipe.title.present? && @recipe.title != "Untitled" ? @recipe.title : "Recipe" %>
<% recipe_description = @recipe.description.present? && @recipe.description != "Nothing here yet..." ? @recipe.description : "A personalized recipe created with LovelyLittleMeal" %>

<% content_for :title, recipe_title %>
<% content_for :description, recipe_description %>
<% content_for :og_type, "article" %>
<% content_for :og_title, recipe_title %>
<% content_for :og_description, recipe_description %>
<% if @recipe.image.attached? %>
  <%# Use absolute URL for OG tags (works with both local storage and Cloudinary) %>
  <% content_for :og_image, absolute_url_for(@recipe.image) %>
<% else %>
  <%# Fallback to LLM OG logo if no recipe image %>
  <% content_for :og_image, public_file_url('llm-og-logo.jpg') %>
<% end %>

<% left_content = capture do %>
  <%# Recipe Header - Sticky, doesn't scroll (only title and buttons) %>
  <div id="recipe-header" class="flex-shrink-0 border-bottom bg-white" style="position: sticky; top: 0; z-index: 10;">
    <div class="p-2">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0"><%= @recipe.title || "Untitled" %></h2>

        <span id="favorite-toggle-<%= @recipe.id %>">
          <%= button_to toggle_favorite_recipe_path(@recipe),
                        method: :patch,
                        class: "btn p-0 border-0 bg-transparent favorite-button",
                        form_class: "d-inline" do %>
            <i class="bi <%= @recipe.favorite? ? 'bi-star-fill text-warning' : 'bi-star' %> fs-3"></i>
          <% end %>
        </span>

        <%= button_to recipe_path(@recipe),
                      method: :delete,
                      data: { turbo_confirm: "Delete this recipe?" },
                      class: "btn p-0 border-0 bg-transparent icon-button",
                      form_class: "d-inline" do %>
          <i class="bi bi-trash fs-3 text-dark"></i>
        <% end %>
      </div>
    </div>
  </div>
  
  <%# Recipe Content - Scrollable (includes description) %>
  <div id="recipe-details" class="overflow-y-auto flex-grow-1 p-2" style="min-height: 0;">
    <% if @recipe.description.present? && @recipe.description != "Nothing here yet..." %>
      <p class="text-muted lead mb-3"><%= @recipe.description %></p>
    <% end %>
    <%= render "recipes/details", recipe: @recipe, skip_header: true %>
  </div>
<% end %>

<% right_content = capture do %>
  <div id="chat-messages" class="overflow-y-auto flex-grow-1 mb-3 d-flex flex-column" style="min-height: 0;" data-chat-target="messages">
    <%# Spacer that grows to push messages to bottom when content is short %>
    <%# When content overflows, this spacer shrinks to 0 and scrolling works normally %>
    <%# Only show spacer when there are messages (empty message handles its own centering) %>
    <% if @messages.any? %>
      <div id="messages-spacer" style="flex: 1 1 0; min-height: 0;"></div>
    <% end %>
    <%# Initial messages or empty state %>
    <% if @messages.any? %>
      <%= render @messages %> 
    <% else %>
      <div id="empty-chat-message" class="d-flex align-items-center justify-content-center flex-grow-1">
        <p class="text-muted mb-0">What are we cooking today?</p>
      </div>
    <% end %>
  </div>
  <%# Separator between messages and input %>
  <div class="border-top mb-3 flex-shrink-0"></div>
  <div id="message-form" class="flex-shrink-0" data-chat-target="form">
    <%= form_with url: message_recipe_path(@recipe),
                  method: :post,
                  class: "d-flex gap-2",
                  data: {
                    turbo_frame: "_top"
                  } do |f| %>
      <%= f.text_field :content,
                       placeholder: "Type...",
                       autofocus: true,
                       autocomplete: "off",
                       id: "message-content",
                       class: "form-control flex-grow-1",
                       data: { chat_target: "input" } %>
      <%= f.submit "Send", class: "btn btn-primary flex-shrink-0", data: { chat_target: "submit" }, disabled: true %>
    <% end %>
  </div>
<% end %>

<%= render "recipes/two_column_layout",
    left_content: left_content,
    right_content: right_content,
    right_attributes: { data: { controller: "chat" } } %>
