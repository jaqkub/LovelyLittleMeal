<div id="recipe-details" class="<%= 'has-content' if recipe.content.present? && recipe.content.is_a?(Hash) && recipe.content.any? %>">
  <%# Recipe Header - Only render if not skipped (for show page, header is in show.html.erb) %>
  <% unless local_assigns[:skip_header] %>
  <div class="mb-4">
    <div class="d-flex align-items-center gap-2 mb-2">
      <h2 class="mb-0"><%= recipe.title || "Untitled" %></h2>

  <span id="favorite-toggle-<%= recipe.id %>">
    <%= button_to toggle_favorite_recipe_path(recipe),
                  method: :patch,
                  class: "btn p-0 border-0 bg-transparent favorite-button",
                  form_class: "d-inline" do %>
      <i class="bi <%= recipe.favorite? ? 'bi-star-fill text-warning' : 'bi-star' %> fs-3"></i>
    <% end %>
  </span>

  <%= button_to recipe_path(recipe),
                method: :delete,
                data: { turbo_confirm: "Delete this recipe?" },
                class: "btn p-0 border-0 bg-transparent icon-button",
                form_class: "d-inline" do %>
    <i class="bi bi-trash fs-3 text-dark"></i>
  <% end %>

    </div>
    <% if recipe.description.present? && recipe.description != "Nothing here yet..." %>
      <p class="text-muted lead mb-0"><%= recipe.description %></p>
    <% end %>
  </div>
  <% end %>
  <%# Recipe Image %>
  <%= render "recipes/image", recipe: recipe, image_regenerating: local_assigns[:image_regenerating] || false %>
  <%# Recipe Content %>
  <% if recipe.content.present? && recipe.content.is_a?(Hash) %>
    <%# Long Description %>
    <% if recipe.content["long_description"].present? %>
      <div class="mb-4">
        <p class="mb-0"><%= simple_format(recipe.content["long_description"]) %></p>
      </div>
    <% end %>
    <%# Ingredients and Instructions - Side by Side %>
    <% has_ingredients = recipe.content["ingredients"].present? && recipe.content["ingredients"].is_a?(Array) && recipe.content["ingredients"].any? %>
    <% has_instructions = recipe.content["instructions"].present? && recipe.content["instructions"].is_a?(Array) && recipe.content["instructions"].any? %>

    <% if has_ingredients || has_instructions %>
      <div class="mb-4 d-flex flex-column flex-md-row gap-4">
        <%# Ingredients Section %>
        <% if has_ingredients %>
          <div class="flex-grow-1" style="min-width: 0;">
            <h3 class="h5 mb-3">Ingredients</h3>
            <ul class="list-unstyled">
              <% recipe.content["ingredients"].each do |ingredient| %>
                <li class="mb-2">
                  <span class="me-2">•</span>
                  <%= ingredient %>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%# Instructions Section %>
        <% if has_instructions %>
          <div class="flex-grow-1" style="min-width: 0;">
            <h3 class="h5 mb-3">Instructions</h3>
            <ol>
              <% recipe.content["instructions"].each do |instruction| %>
                <li class="mb-3">
                  <%= simple_format(instruction) %>
                </li>
              <% end %>
            </ol>
          </div>
        <% end %>
      </div>
    <% end %>
  <% end %>
  <%# Shopping List Section %>
  <% if recipe.shopping_list.present? && recipe.shopping_list.is_a?(Array) && recipe.shopping_list.any? %>
    <%# Filter out invalid entries - only keep non-empty strings %>
    <% valid_items = recipe.shopping_list.select { |item| item.is_a?(String) && item.present? && item.strip.length > 0 } %>
    <% if valid_items.any? %>
      <div class="mb-4" data-controller="clipboard">
        <div class="d-flex align-items-center gap-2 mb-3">
          <h3 class="h5 mb-0">Shopping List</h3>
          <button type="button"
                  class="btn btn-sm btn-outline-secondary p-1"
                  data-action="click->clipboard#copy"
                  title="Copy shopping list to clipboard"
                  aria-label="Copy shopping list to clipboard">
            <i class="bi bi-clipboard fs-6"></i>
          </button>
        </div>
        <div class="bg-light p-3 rounded" data-clipboard-target="source">
          <ul class="list-unstyled mb-0">
            <% valid_items.each do |item| %>
              <li >
                <span class="me-2">•</span>
                <%= item.strip %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    <% end %>
  <% end %>
  <%# Empty State %>
  <% if (!recipe.content.present? || !recipe.content.is_a?(Hash) || recipe.content.empty?) &&
        (!recipe.shopping_list.present? || recipe.shopping_list.empty?) %>
  <div class="text-center text-muted py-5">
    <p class="mb-0">Start chatting to generate a recipe!</p>
    <p class="mb-0">Or paste a link to work on a recipe you found online.</p>
  </div>
<% end %>
</div>