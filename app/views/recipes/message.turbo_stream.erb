<%# Remove "What are we cooking today?" message if it exists (only on first message) %>
<%# JavaScript handles adding the spacer when empty message is hidden %>
<% if @chat.messages.count == 2 %>
  <%= turbo_stream.remove "empty-chat-message" %>
<% end %>

<%# Replace optimistic user message with server-rendered one (maintains position/order) %>
<%# The optimistic message should always exist since we add it on form submit %>
<%= turbo_stream.replace "optimistic-user-msg" do %>
  <%= render "messages/message", message: @user_message %>
<% end %>

<%# Replace the optimistic loading bubble with actual AI response %>
<%# Order is maintained: user message (replaced above, stays in place) -> AI message (replaces loading bubble) %>
<%= turbo_stream.replace "loading" do %>
  <%= render "messages/message", message: @ai_message %>
<% end %>

<%# Update recipe details section ONLY if recipe actually changed %>
<%# For questions, the recipe stays the same so we don't need to update the view %>
<% if @recipe_changed %>
  <%# Update recipe header (title and buttons only - description goes in scrollable area) %>
  <%= turbo_stream.replace "recipe-header" do %>
    <div id="recipe-header" class="flex-shrink-0 border-bottom bg-white" style="position: sticky; top: 0; z-index: 10;">
      <div class="p-2">
        <div class="d-flex align-items-center gap-2">
          <h2 class="mb-0"><%= @recipe.title || "Untitled" %></h2>

          <span id="favorite-toggle-<%= @recipe.id %>">
            <%= button_to toggle_favorite_recipe_path(@recipe),
                          method: :patch,
                          class: "btn p-0 border-0 bg-transparent favorite-button",
                          form_class: "d-inline" do %>
              <i class="bi <%= @recipe.favorite? ? 'bi-star-fill text-warning' : 'bi-star' %> fs-3"></i>
            <% end %>
          </span>

          <%= button_to recipe_path(@recipe),
                        method: :delete,
                        data: { turbo_confirm: "Delete this recipe?" },
                        class: "btn p-0 border-0 bg-transparent icon-button",
                        form_class: "d-inline" do %>
            <i class="bi bi-trash fs-3 text-dark"></i>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
  
  <%# Update recipe content (scrollable area - includes description) %>
  <%= turbo_stream.replace "recipe-details" do %>
    <div id="recipe-details" class="overflow-y-auto flex-grow-1 p-2" style="min-height: 0;">
      <% if @recipe.description.present? && @recipe.description != "Nothing here yet..." %>
        <p class="text-muted lead mb-3"><%= @recipe.description %></p>
      <% end %>
      <%= render "recipes/details", recipe: @recipe, image_regenerating: @image_regenerating, skip_header: true %>
    </div>
  <% end %>
<% end %>

<%# Clear the message input form and reset it %>
<%= turbo_stream.update "message-form" do %>
  <%= form_with url: message_recipe_path(@recipe),
                method: :post,
                class: "d-flex gap-2",
                data: { 
                  turbo_frame: "_top"
                } do |f| %>
    <%= f.text_field :content,
                     placeholder: "Type...",
                     autofocus: true,
                     autocomplete: "off",
                     id: "message-content",
                     class: "form-control flex-grow-1",
                     data: { chat_target: "input" },
                     value: "" %>
    <%= f.submit "Send", class: "btn btn-primary flex-shrink-0", data: { chat_target: "submit" }, disabled: true %>
  <% end %>
<% end %>
