<%# Remove "What are we cooking today?" message if it exists (only on first message) %>
<%# JavaScript handles adding the spacer when empty message is hidden %>
<% if @chat.messages.count == 2 %>
  <%= turbo_stream.remove "empty-chat-message" %>
<% end %>

<%# Replace optimistic user message with server-rendered one (maintains position/order) %>
<%# The optimistic message should always exist since we add it on form submit %>
<%= turbo_stream.replace "optimistic-user-msg" do %>
  <%= render "messages/message", message: @user_message %>
<% end %>

<%# Replace the optimistic loading bubble with actual AI response %>
<%# Order is maintained: user message (replaced above, stays in place) -> AI message (replaces loading bubble) %>
<%= turbo_stream.replace "loading" do %>
  <%= render "messages/message", message: @ai_message %>
<% end %>

<%# Update recipe details section ONLY if recipe actually changed %>
<%# For questions, the recipe stays the same so we don't need to update the view %>
<% if @recipe_changed %>
  <%= turbo_stream.replace "recipe-details" do %>
    <%= render "recipes/details", recipe: @recipe %>
  <% end %>
<% end %>

<%# Clear the message input form and reset it %>
<%= turbo_stream.update "message-form" do %>
  <%= form_with url: message_recipe_path(@recipe),
                method: :post,
                class: "d-flex gap-2",
                data: { 
                  turbo_frame: "_top"
                } do |f| %>
    <%= f.text_field :content,
                     placeholder: "Type...",
                     autofocus: true,
                     autocomplete: "off",
                     id: "message-content",
                     class: "form-control flex-grow-1",
                     data: { chat_target: "input" },
                     value: "" %>
    <%= f.submit "Send", class: "btn btn-primary flex-shrink-0", data: { chat_target: "submit" }, disabled: true %>
  <% end %>
<% end %>
